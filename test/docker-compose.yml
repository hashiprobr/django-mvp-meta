version: '3.7'

services:
  cache:
    image: memcached:${MEMCACHED_VERSION}
    command: -p 11211
    restart: unless-stopped

  broker:
    image: redis:${REDIS_VERSION}
    command: --port 6379
    restart: unless-stopped

  db:
    image: postgres:${POSTGRES_VERSION}
    volumes:
      - ./db:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: ${DATABASE_NAME}
      POSTGRES_USER: ${DATABASE_USER}
      POSTGRES_PASSWORD: ${DATABASE_PASSWORD}
    command: -p 5432
    restart: unless-stopped

  filestore:
    image: minio/minio:${MINIO_VERSION}
    volumes:
      - ./filestore:/data
      - /etc/letsencrypt/live/${STAGE_HOST}/fullchain.pem:/certs/public.crt:ro
      - /etc/letsencrypt/live/${STAGE_HOST}/privkey.pem:/certs/private.key:ro
    environment:
      MINIO_ACCESS_KEY: ${AWS_ACCESS_KEY_ID}
      MINIO_SECRET_KEY: ${AWS_SECRET_ACCESS_KEY}
      MINIO_BROWSER: 0
    command: server /data --address :9000 --certs-dir /certs
    ports:
      - 9000:9000
    restart: unless-stopped

  web:
    image: ${IMAGE_NAME}:latest
    build:
      context: ..
      args:
        python_version: ${PYTHON_VERSION}
        base_dir: ${BASE_DIR}
        base_name: ${BASE_NAME}
    environment:
      CONTAINED: 1
      SECRET_KEY: ${SECRET_KEY}
      ALLOWED_HOSTS: ${ALLOWED_HOSTS}
      CACHE_HOST: cache
      CACHE_PORT: 11211
      BROKER_HOST: broker
      BROKER_PORT: 6379
      DATABASE_HOST: db
      DATABASE_PORT: 5432
      DATABASE_NAME: ${DATABASE_NAME}
      DATABASE_USER: ${DATABASE_USER}
      DATABASE_PASSWORD: ${DATABASE_PASSWORD}
      AWS_S3_ENDPOINT_URL: https://${FILESTORE_HOST}:9000
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      EMAIL_HOST: ${EMAIL_HOST}
      EMAIL_PORT: ${EMAIL_PORT}
      EMAIL_HOST_USER: ${EMAIL_HOST_USER}
      EMAIL_HOST_PASSWORD: ${EMAIL_HOST_PASSWORD}
      EMAIL_USE_TLS: ${EMAIL_USE_TLS}
      EMAIL_USE_SSL: ${EMAIL_USE_SSL}
      DEFAULT_FROM_EMAIL: ${DEFAULT_FROM_EMAIL}
    restart: unless-stopped

  proxy:
    image: nginx:${NGINX_VERSION}
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - /etc/letsencrypt/live/${STAGE_HOST}/fullchain.pem:/etc/letsencrypt/fullchain.pem:ro
      - /etc/letsencrypt/live/${STAGE_HOST}/privkey.pem:/etc/letsencrypt/privkey.pem:ro
      - /etc/letsencrypt/ssl-dhparams.pem:/etc/letsencrypt/ssl-dhparams.pem:ro
    ports:
      - 80:80
      - 443:443
    restart: unless-stopped
